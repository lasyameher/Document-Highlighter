@{
    ViewData["Title"] = "PDF Highlighter";
}

<div class="container mt-4">

    <h2>PDF Highlighter</h2>

    <div class="row mt-4">
        <div class="col-md-4">

            <label class="form-label fw-bold">Upload PDF File</label>
            <input type="file" id="pdfFile" accept="application/pdf" class="form-control" />

            <label class="form-label fw-bold mt-3">Upload JSON (Azure DI Layout)</label>
            <input type="file" id="jsonFile" accept=".json" class="form-control" />

            <label class="form-label fw-bold mt-3">Search Text</label>
            <input type="text" id="searchText" class="form-control" placeholder="Enter keyword like 'Jimmy'" />

            <button class="btn btn-primary mt-3 w-100" onclick="uploadFiles()">Upload & Highlight</button>

        </div>

        <div class="col-md-8">

            <div class="border mt-2" id="viewerContainer"
                 style="height: 900px; overflow-y: scroll; position: relative;">
                <div id="pdfViewer"></div>
            </div>

        </div>
    </div>

</div>

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.10.111/pdf.min.js"></script>

<script>
    let pdfDoc = null;
    let highlightResults = [];

    // ============================================================
    // UPLOAD → PROCESS → RENDER
    // ============================================================
    async function uploadFiles() {
        const pdfFile = document.getElementById("pdfFile").files[0];
        const jsonFile = document.getElementById("jsonFile").files[0];
        const searchText = document.getElementById("searchText").value;

        if (!pdfFile || !jsonFile || !searchText) {
            alert("Select files + enter text.");
            return;
        }

        const fd = new FormData();
        fd.append("pdfFile", pdfFile);
        fd.append("jsonFile", jsonFile);
        fd.append("searchText", searchText);

        const uploadResp = await fetch("/pdf/upload", {
            method: "POST",
            body: fd
        });

        const data = await uploadResp.json();

        await processJson(data.json, data.searchString);
        await renderPdf(data.pdfUrl);
    }

    // ============================================================
    // SEND JSON TO PROCESSOR
    // ============================================================
    async function processJson(raw, searchText) {
        const resp = await fetch("/pdf/process-json", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ json: raw, searchText })
        });

        highlightResults = await resp.json();
        console.log(highlightResults);
    }

    async function renderPdf(url) {
        document.getElementById("pdfViewer").innerHTML = "";

        const task = pdfjsLib.getDocument(url);
        pdfDoc = await task.promise;

        for (let pageNum = 1; pageNum <= pdfDoc.numPages; pageNum++) {
            const page = await pdfDoc.getPage(pageNum);
            const viewport = page.getViewport({ scale: 1.5 });
            console.log(viewport)

            const canvas = document.createElement("canvas");
            canvas.classList.add("pdf-page");
            canvas.width = viewport.width;
            canvas.height = viewport.height;

            const ctx = canvas.getContext("2d");
            document.getElementById("pdfViewer").appendChild(canvas);

            await page.render({ canvasContext: ctx, viewport }).promise;
            console.log(ctx)

            drawHighlights(canvas, pageNum, viewport);
        }
    }

    function polygonToRect(poly) {
        const xs = [poly[0], poly[2], poly[4], poly[6]];
        const ys = [poly[1], poly[3], poly[5], poly[7]];

        const minX = Math.min(...xs);
        const maxX = Math.max(...xs);
        const minY = Math.min(...ys);
        const maxY = Math.max(...ys);

        return { x: minX, y: minY, w: maxX - minX, h: maxY - minY };
    }

    function drawHighlights(canvas, pageNumber, viewport) {
        const ctx = canvas.getContext("2d");

        // Results from backend
        const matches = highlightResults.filter(h => h.pageNumber === pageNumber);

        matches.forEach(b => {

            let x, y, w, h;

            // ---------------------------------------------------------
            // Detect if this is single-word polygon or multi-word rect
            // ---------------------------------------------------------
            if (b.polygon.length === 8) {
                // SINGLE WORD → polygon → rect
                const rect = polygonToRect(b.polygon);
                x = rect.x;
                y = rect.y;
                w = rect.w;
                h = rect.h;
            }
            else if (b.polygon.length === 4) {
                // MULTI WORD → already a merged rect
                [x, y, w, h] = b.polygon;
            }
            else {
                console.warn("Invalid bounding box:", b.polygon);
                return;
            }

            // ---------------------------------------------------------
            // PDF inches → points
            // ---------------------------------------------------------
            const scaleFactor = 72;
            const xPt = x * scaleFactor;
            const yPt = y * scaleFactor;
            const wPt = w * scaleFactor;
            const hPt = h * scaleFactor;

            // Page height (for Y flip)
            const pageHeightPoints = b.pageHeight * scaleFactor;

            // ---------------------------------------------------------
            // Flip Y axis (PDF = bottom-left → Canvas = top-left)
            // ---------------------------------------------------------
            const flippedY = pageHeightPoints - (yPt + hPt);

            // ---------------------------------------------------------
            // Convert PDF points → viewport PX
            // ---------------------------------------------------------
            const rectPx = viewport.convertToViewportRectangle([
                xPt,
                flippedY,
                xPt + wPt,
                flippedY + hPt
            ]);

            const X = rectPx[0];
            const Y = rectPx[1];
            const W = rectPx[2] - rectPx[0];
            const H = rectPx[3] - rectPx[1];

            // ---------------------------------------------------------
            // 5️⃣ Draw highlight
            // ---------------------------------------------------------
            ctx.fillStyle = "rgba(255, 255, 0, 0.35)";
            ctx.fillRect(X, Y, W, H);

            ctx.strokeStyle = "rgba(255, 200, 0, 1)";
            ctx.lineWidth = 2;
            ctx.strokeRect(X, Y, W, H);
        });
    }

</script>

